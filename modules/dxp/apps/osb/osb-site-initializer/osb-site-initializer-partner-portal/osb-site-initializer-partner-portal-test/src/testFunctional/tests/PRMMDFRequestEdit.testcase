@component-name = "OSB Site Initializer Partner Portal"
definition {

	property custom.properties = "feature.flag.LPS-135430=true";
	property osgi.modules.includes = "osb-site-initializer-partner-portal";
	property portal.release = "false";
	property portal.upstream = "true";
	property release.feature.flags.disable.DISABLE_PRIVATE_LAYOUTS = "true";
	property testray.main.component.name = "OSB Site Initializer Partner Portal";

	setUp {
		task ("Set up instance and sign in") {
			TestCase.setUpPortalInstance();

			User.firstLoginPG();
		}

		task ("Create a new Partner Portal Site and connect with Salesforce") {
			PRMUtils.addSite();

			PRMUtils.connectWithSalesforce();
		}

		task ("Update the account with Salesforce fields") {
			JSONPRM.updateAccount();
		}

		task ("Assign the users to the account") {
			JSONAccountEntryUser.addExistUsertoAccount(
				accountEntryName = "Company Name 1",
				userEmailAddress = "pmu@partner.com");

			JSONAccountEntryUser.addExistUsertoAccount(
				accountEntryName = "Company Name 1",
				userEmailAddress = "cmm@liferaytest.com");
		}

		task ("Login with the Partner user and create an MDF Request") {
			User.logoutAndLoginPG(
				userLoginEmailAddress = "pmu@partner.com",
				userLoginFullName = "pmu");

			var requestId = JSONPRM.createMDFRequest(
				campaignName = "Campaign Name",
				userEmailAddress = "pmu@partner.com");
		}

		task ("Go to the created MDF Request") {
			PRMNavigator.openSitePage(pageName = "MDF Requests");

			PRMMDFRequest.goToMDF(campaignName = "Campaign Name");
		}
	}

	tearDown {
		var testLiferayVirtualInstance = PropsUtil.get("test.liferay.virtual.instance");

		if (${testLiferayVirtualInstance} == "true") {
			PortalInstances.tearDownCP();
		}
		else {
			PRMUtils.tearDown();
		}
	}

	@description = "This is a test for LPS-182807. Verify that it is possible to remove an activity while editing"
	@priority = 5
	test CanRemoveActivityWhileEditing {
		property test.liferay.virtual.instance = "false";
		property test.run.type = "single";

		task ("Given that the PMU creates a new MDF Request") {
			var requestId = JSONPRM.createMDFRequest(
				accountEntryName = "Company Name 1",
				secondActivityName = "Activity Name 2",
				secondBudgetValueList = 1000,
				userEmailAddress = "pmu@partner.com");
		}

		task ("And the CMM change the MDF status to 'More Info Requested") {
			JSONPRM.changeMDFStatus(
				mdfStatus = "More Info Requested",
				requestId = ${requestId},
				userEmailAddress = "cmm@liferaytest.com");
		}

		task ("When the PMU goes to edit the MDF and remove one of the activities") {
			PRMNavigator.gotoMDF(requestId = ${requestId});

			PRMMDFRequest.editButton();

			PRMMDFRequest.editMDF(
				campaignName = "Campaign Name Edited",
				removeActivity = "Activity Name 2");
		}

		task ("Then the removed activity will be no longer visible") {
			PRMNavigator.gotoMDF(requestId = ${staticRequestId});

			PRMMDFRequest.viewActivityNotPresent(activityName = "Activity Name 2");
		}
	}

	@description = "This is a test for LPS-187088. Verify that it is possible to remove a budget while editing"
	@priority = 5
	test CanRemoveBudgetWhileEditing {
		property test.liferay.virtual.instance = "false";
		property test.run.type = "single";

		task ("Given that the PMU creates a new MDF Request") {
			var requestId = JSONPRM.createMDFRequest(
				accountEntryName = "Company Name 1",
				budgetValueList = "1000,2000,3000",
				userEmailAddress = "pmu@partner.com");
		}

		task ("And the CMM change the MDF status to 'More Info Requested") {
			JSONPRM.changeMDFStatus(
				mdfStatus = "More Info Requested",
				requestId = ${requestId},
				userEmailAddress = "cmm@liferaytest.com");
		}

		task ("And the PMU get the current MDF Total and Request costs") {
			PRMNavigator.gotoMDF(requestId = ${requestId});

			var oldTotalCost = selenium.getText("PRMMDFRequestDetailPage#PANEL_TOTAL_COST");
			var oldRequestCost = selenium.getText("PRMMDFRequestDetailPage#PANEL_REQUESTED_COST");
		}

		task ("When the PMU goes to edit the MDF and remove one of the budgets") {
			PRMMDFRequest.editButton();

			PRMMDFRequest.editMDF(
				activityName = "Activity Name",
				removeBudgetByIndex = 3);
		}

		task ("Then the removed budget will be no longer visible and the MDF values will be updated") {
			task ("Go the the MDF") {
				PRMNavigator.gotoMDF(requestId = ${staticRequestId});
			}

			task ("Get the new MDF Total and Request costs") {
				var newTotalCost = selenium.getText("PRMMDFRequestDetailPage#PANEL_TOTAL_COST");
				var newRequestCost = selenium.getText("PRMMDFRequestDetailPage#PANEL_REQUESTED_COST");
			}

			task ("Compare the initial and new values") {
				TestUtils.assertNotEquals(
					actual = ${oldTotalCost},
					expected = ${newTotalCost});

				TestUtils.assertNotEquals(
					actual = ${oldRequestCost},
					expected = ${newRequestCost});
			}

			task ("Verify that the remove budget isn't displayed on activity details") {
				PRMMDFRequestDetailPage.expandActivityDetails(activityName = "Activity Name");

				PRMMDFRequestDetailPage.viewBudgetNotPresent(
					budgetIndex = 3,
					budgetName = "Content Creation");
			}
		}
	}

	@description = "This is a test for LPS-182807. Verify that the CMM can edit MDF in Approved status"
	@priority = 5
	test CMMCanEditMDFInApprovedStatus {
		property test.liferay.virtual.instance = "false";
		property test.run.type = "single";

		task ("Given that the CMM goes to the submitted MDF") {
			User.logoutAndLoginPG(
				userLoginEmailAddress = "cmm@liferaytest.com",
				userLoginFullName = "cmm");

			PRMNavigator.gotoMDF(requestId = ${staticRequestId});
		}

		task ("And change the MDF status") {
			PRMMDFRequest.changeMDFStatus(statusButton = "Approve");
		}

		task ("When the CMM edit the MDF information and submit it") {
			PRMMDFRequest.editButton();

			PRMMDFRequest.editMDF(
				activityName = "Activity Name",
				campaignName = "Campaign Name Edited",
				newActivityName = "Activity Name Edited",
				newBugdetValue = 2000);
		}

		task ("Then the information will be updated") {
			PRMNavigator.gotoMDF(requestId = ${staticRequestId});

			PRMMDFRequest.viewMDFCompanyDetails(campaignName = "Campaign Name Edited");

			PRMMDFRequest.viewMDFActivityDetails(
				activityName = "Activity Name Edited",
				budget = "2,000",
				expense = "Content Creation");
		}
	}

	@description = "This is a test for LPS-182809. Verify that the CMM can edit MDF in Canceled status"
	@priority = 5
	test CMMCanEditMDFInCanceledStatus {
		property test.liferay.virtual.instance = "false";
		property test.run.type = "single";

		task ("Given that the CMM goes to the submitted MDF") {
			User.logoutAndLoginPG(
				userLoginEmailAddress = "cmm@liferaytest.com",
				userLoginFullName = "cmm");

			PRMNavigator.gotoMDF(requestId = ${staticRequestId});
		}

		task ("And change the MDF status") {
			PRMMDFRequest.changeMDFStatus(statusButton = "Cancel");
		}

		task ("When the CMM edit the MDF information and submit it") {
			PRMMDFRequest.editButton();

			PRMMDFRequest.editMDF(
				activityName = "Activity Name",
				campaignName = "Campaign Name Edited",
				newActivityName = "Activity Name Edited",
				newBugdetValue = 2000);
		}

		task ("Then the information will be updated") {
			PRMNavigator.gotoMDF(requestId = ${staticRequestId});

			PRMMDFRequest.viewMDFCompanyDetails(campaignName = "Campaign Name Edited");

			PRMMDFRequest.viewMDFActivityDetails(
				activityName = "Activity Name Edited",
				budget = "2,000",
				expense = "Content Creation");
		}
	}

	@description = "This is a test for LPS-179227. Verify that the CMM can edit MDF in Marketing Director Review status"
	@priority = 5
	test CMMCanEditMDFInMarketingDirectorReviewStatus {
		property test.liferay.virtual.instance = "false";
		property test.run.type = "single";

		task ("Given that the CMM goes to the submitted MDF") {
			User.logoutAndLoginPG(
				userLoginEmailAddress = "cmm@liferaytest.com",
				userLoginFullName = "cmm");

			PRMNavigator.gotoMDF(requestId = ${staticRequestId});
		}

		task ("And change the MDF status") {
			PRMMDFRequest.changeMDFStatus(statusButton = "Marketing Director Review");
		}

		task ("When the CMM edit the MDF information and submit it") {
			PRMMDFRequest.editButton();

			PRMMDFRequest.editMDF(
				activityName = "Activity Name",
				campaignName = "Campaign Name Edited",
				newActivityName = "Activity Name Edited",
				newBugdetValue = 2000);
		}

		task ("Then the information will be updated") {
			PRMNavigator.gotoMDF(requestId = ${staticRequestId});

			PRMMDFRequest.viewMDFCompanyDetails(campaignName = "Campaign Name Edited");

			PRMMDFRequest.viewMDFActivityDetails(
				activityName = "Activity Name Edited",
				budget = "2,000",
				expense = "Content Creation");
		}
	}

	@description = "This is a test for LPS-182806. Verify that the CMM can edit MDF in Pending Marketing Review status"
	@priority = 5
	test CMMCanEditMDFInPendingMarketingReviewStatus {
		property test.liferay.virtual.instance = "false";
		property test.run.type = "single";

		task ("Given that the CMM goes to the submitted MDF, which is as 'Pending Marketing Review'") {
			User.logoutAndLoginPG(
				userLoginEmailAddress = "cmm@liferaytest.com",
				userLoginFullName = "cmm");

			PRMNavigator.gotoMDF(requestId = ${staticRequestId});
		}

		task ("When the CMM edit the MDF information and submit it") {
			PRMMDFRequest.editButton();

			PRMMDFRequest.editMDF(
				activityName = "Activity Name",
				campaignName = "Campaign Name Edited",
				newActivityName = "Activity Name Edited",
				newBugdetValue = 2000);
		}

		task ("Then the information will be updated") {
			PRMNavigator.gotoMDF(requestId = ${staticRequestId});

			PRMMDFRequest.viewMDFCompanyDetails(campaignName = "Campaign Name Edited");

			PRMMDFRequest.viewMDFActivityDetails(
				activityName = "Activity Name Edited",
				budget = "2,000",
				expense = "Content Creation");
		}
	}

	@description = "This is a test for LPS-182808. Verify that the CMM can edit MDF in Rejected status"
	@priority = 5
	test CMMCanEditMDFInRejectedStatus {
		property test.liferay.virtual.instance = "false";
		property test.run.type = "single";

		task ("Given that the CMM goes to the submitted MDF") {
			User.logoutAndLoginPG(
				userLoginEmailAddress = "cmm@liferaytest.com",
				userLoginFullName = "cmm");

			PRMNavigator.gotoMDF(requestId = ${staticRequestId});
		}

		task ("And change the MDF status") {
			PRMMDFRequest.changeMDFStatus(statusButton = "Rejected");
		}

		task ("When the CMM edit the MDF information and submit it") {
			PRMMDFRequest.editButton();

			PRMMDFRequest.editMDF(
				activityName = "Activity Name",
				campaignName = "Campaign Name Edited",
				newActivityName = "Activity Name Edited",
				newBugdetValue = 2000);
		}

		task ("Then the information will be updated") {
			PRMNavigator.gotoMDF(requestId = ${staticRequestId});

			PRMMDFRequest.viewMDFCompanyDetails(campaignName = "Campaign Name Edited");

			PRMMDFRequest.viewMDFActivityDetails(
				activityName = "Activity Name Edited",
				budget = "2,000",
				expense = "Content Creation");
		}
	}

	@description = "This is a test for LPS-187090. Verify that the PMU can edit an MDF in 'Draft' Status"
	@priority = 5
	test PMUCanEditMDFInDraftStatus {
		property test.liferay.virtual.instance = "false";
		property test.run.type = "single";

		task ("Given that a MDF Request is saved as draft") {
			PRMNavigator.openSitePage(pageName = "MDF Requests");

			Button.click(button = "New Request");

			PRMMDFRequest.fillGoalsPage(
				accountName = "Company Name 1",
				campaignDescription = "Campaign Description",
				campaignName = "Campaign Name Draft",
				goalsOptions = "Lead generation",
				targetMarketOptions = "Education,Energy",
				targetRolesOptions = "Administrator");

			Button.click(button = "Save as Draft");
		}

		task ("And the PMU goes to edit the draft MDF") {
			PRMMDFRequest.goToMDF(campaignName = "Campaign Name Draft");

			PRMMDFRequest.editButton();
		}

		task ("When the PMU add a new activity and change the MDF name") {
			PRMMDFRequest.editMDF(
				activityDescription = "Campaign Description",
				budgetList = "Sponsorship Fee-2000",
				campaignName = "Campaign Name Edited",
				leadList = "No",
				newActivity = "Activity Name Added",
				tactic = "Other",
				typeOfActivity = "Miscellaneous Marketing");
		}

		task ("Then the MDF information will be updated") {
			PRMMDFRequest.goToMDF(campaignName = "Campaign Name Edited");

			PRMMDFRequest.viewMDFCompanyDetails(campaignName = "Campaign Name Edited");

			PRMMDFRequest.viewMDFActivityDetails(
				activityName = "Activity Name Added",
				budget = "2,000",
				expense = "Sponsorship Fee");
		}
	}

	@description = "This is a test for LPS-187087. Verify that the Partner can edit an MDF in 'More Info Requested' Status"
	@priority = 5
	test PMUCanEditMDFInRequestMoreInfoStatus {
		property test.liferay.virtual.instance = "false";
		property test.run.type = "single";

		task ("Given that the CMM changes the MDF status to 'More Info Requested'") {
			JSONPRM.changeMDFStatus(
				mdfStatus = "More Info Requested",
				requestId = ${staticRequestId},
				userEmailAddress = "cmm@liferaytest.com");
		}

		task ("And the PMU goes to edit the created MDF") {
			PRMNavigator.gotoMDF(requestId = ${staticRequestId});

			PRMMDFRequest.editButton();
		}

		task ("When the PMU edit the MDF information and submit it ") {
			PRMMDFRequest.editMDF(
				activityName = "Activity Name",
				campaignName = "Campaign Name Edited",
				newActivityName = "Activity Name Edited",
				newBugdetValue = 2000);
		}

		task ("Then the information will be updated") {
			PRMMDFRequest.goToMDF(campaignName = "Campaign Name Edited");

			PRMMDFRequest.viewMDFCompanyDetails(campaignName = "Campaign Name Edited");

			PRMMDFRequest.viewMDFActivityDetails(
				activityName = "Activity Name Edited",
				budget = "2,000",
				expense = "Content Creation");
		}
	}

}