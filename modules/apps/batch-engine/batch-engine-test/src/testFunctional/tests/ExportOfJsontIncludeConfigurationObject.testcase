@component-name = "portal-batch-engine"
definition {

	property custom.properties = "feature.flag.COMMERCE-8087=true";
	property portal.release = "true";
	property portal.upstream = "true";
	property testray.component.names = "Object";
	property testray.main.component.name = "Batch Engine";

	setUp {
		TestCase.setUpPortalInstance();

		User.firstLoginPG();
	}

	tearDown {
		var testLiferayVirtualInstance = PropsUtil.get("test.liferay.virtual.instance");

		ObjectAdmin.deleteAllCustomObjectsViaAPI();

		BatchPlanner.batchPlannerTearDown();

		if (${testLiferayVirtualInstance} == "true") {
			PortalInstances.tearDownCP();
		}
	}

	@priority = 3
	test JSONTConfigurationObjectContainsCallbackURL {
		task ("When in Import/Export: exporting DSEnvelope Entity type with JSONT format with all fields to include selected") {
			ImportExport.exportEntityWithAllFieldsInJsontFormat(entityType = "DSEnvelope (v1_0 - Liferay Digital Signature REST)");
		}

		task ("And When I download generated file") {
			ImportExport.unzipDownloadedExportFile();
		}

		task ("Then the jsont format file contains configuration node with callbackURL parameter") {
			BatchEngine.assertExportedFileContainsCorrectObject(
				expectedValue = "",
				fileName = "export.batch-engine-data.json",
				jsonObject = "$.configuration..callbackURL");
		}
	}

	@priority = 5
	test JSONTConfigurationObjectContainsClassname {
		property portal.acceptance = "true";

		task ("When in Import/Export: exporting C_Stock Entity type with JSONT format with all fields to include selected") {
			ObjectDefinitionAPI.createAndPublishObjectDefinition(
				en_US_label = "stock",
				en_US_plural_label = "stocks",
				name = "Stock",
				requiredStringFieldName = "name");

			ImportExport.exportEntityWithAllFieldsInJsontFormat(entityType = "C_Stock (v1_0 - Liferay Object REST)");
		}

		task ("And When I download generated file") {
			ImportExport.unzipDownloadedExportFile();
		}

		task ("Then the jsont format file contains configuration node with className 'com.liferay.object.rest.dto.v1_0.ObjectEntry' parameter") {
			BatchEngine.assertExportedFileContainsCorrectObject(
				expectedValue = "com.liferay.object.rest.dto.v1_0.ObjectEntry",
				fileName = "export.batch-engine-data.json",
				jsonObject = "$.configuration.className");
		}
	}

	@priority = 4
	test JSONTConfigurationObjectContainsCompanyId {
		property portal.acceptance = "true";

		task ("When in Import/Export: exporting Blog Posting Entity type with JSONT format with all fields to include selected") {
			ImportExport.exportEntityWithAllFieldsInJsontFormat(entityType = "BlogPosting (v1_0 - Liferay Headless Delivery)");
		}

		task ("And When I download generated file") {
			ImportExport.unzipDownloadedExportFile();
		}

		task ("Then the jsont format file contains configuration node with companyId parameter") {
			var companyId = JSONCompany.getCompanyId();

			BatchEngine.assertExportedFileContainsCorrectObject(
				expectedValue = ${companyId},
				fileName = "export.batch-engine-data.json",
				jsonObject = "$.configuration.companyId");
		}
	}

	@priority = 4
	test JSONTConfigurationObjectContainsCreateStrategy {
		property portal.acceptance = "true";

		task ("When in Import/Export: exporting NotificationTemplate Entity type with JSONT format with all fields to include selected") {
			ImportExport.exportEntityWithAllFieldsInJsontFormat(entityType = "NotificationTemplate (v1_0 - Liferay Notification REST)");
		}

		task ("And When I download generated file") {
			ImportExport.unzipDownloadedExportFile();
		}

		task ("Then the jsont format file contains configuration node with parameters.createStrategy parameter with 'INSERT' value") {
			BatchEngine.assertExportedFileContainsCorrectObject(
				expectedValue = "INSERT",
				fileName = "export.batch-engine-data.json",
				jsonObject = "$.configuration.parameters.createStrategy");
		}
	}

	@priority = 4
	test JSONTConfigurationObjectContainsImportStrategy {
		property portal.acceptance = "true";

		task ("When in Import/Export: exporting Role (Headless Admin) Entity type with JSONT format with all fields to include selected") {
			ImportExport.exportEntityWithAllFieldsInJsontFormat(entityType = "Role (v1_0 - Liferay Headless Admin User)");
		}

		task ("And When I download generated file") {
			ImportExport.unzipDownloadedExportFile();
		}

		task ("Then the jsont format file contains configuration node with parameters.importStrategy parameter with 'false' value") {
			BatchEngine.assertExportedFileContainsCorrectObject(
				expectedValue = "ON_ERROR_FAIL",
				fileName = "export.batch-engine-data.json",
				jsonObject = "$.configuration.parameters.importStrategy");
		}
	}

	@priority = 3
	test JSONTConfigurationObjectContainsTaskItemDelegateName {
		task ("When in Import/Export: exporting C_Stock Entity type with JSONT format with all fields to include selected") {
			ObjectDefinitionAPI.createAndPublishObjectDefinition(
				en_US_label = "stock",
				en_US_plural_label = "stocks",
				name = "Stock",
				requiredStringFieldName = "name");

			ImportExport.exportEntityWithAllFieldsInJsontFormat(entityType = "C_Stock (v1_0 - Liferay Object REST)");
		}

		task ("And When I download generated file") {
			ImportExport.unzipDownloadedExportFile();
		}

		task ("Then the jsont format file contains configuration node with taskItemDelegateName parameter with 'C_Stock' value") {
			BatchEngine.assertExportedFileContainsCorrectObject(
				expectedValue = "C_Stock",
				fileName = "export.batch-engine-data.json",
				jsonObject = "$.configuration..taskItemDelegateName");
		}
	}

	@priority = 4
	test JSONTConfigurationObjectContainsUpdateStrategy {
		property portal.acceptance = "true";

		task ("When in Import/Export: exporting UserGroup Entity type with JSONT format with all fields to include selected") {
			ImportExport.exportEntityWithAllFieldsInJsontFormat(entityType = "UserGroup (v1_0 - Liferay Headless Admin User)");
		}

		task ("And When I download generated file") {
			ImportExport.unzipDownloadedExportFile();
		}

		task ("Then the jsont format file contains configuration node with parameters.updateStrategy parameter with 'UPDATE' value") {
			BatchEngine.assertExportedFileContainsCorrectObject(
				expectedValue = "UPDATE",
				fileName = "export.batch-engine-data.json",
				jsonObject = "$.configuration.parameters.updateStrategy");
		}
	}

	@priority = 4
	test JSONTConfigurationObjectContainsUserId {
		property portal.acceptance = "true";

		task ("When in Import/Export: exporting Admin User Entity type with JSONT format with all fields to include selected") {
			ImportExport.exportEntityWithAllFieldsInJsontFormat(entityType = "Account (v1_0 - Liferay Headless Admin User)");
		}

		task ("And When I download generated file") {
			ImportExport.unzipDownloadedExportFile();
		}

		task ("Then the jsont format file contains configuration node with userId {userId} parameter") {
			var userId = JSONUserAPI._getUserIdByEmailAddress(userEmailAddress = "test@liferay.com");

			BatchEngine.assertExportedFileContainsCorrectObject(
				expectedValue = ${userId},
				fileName = "export.batch-engine-data.json",
				jsonObject = "$.configuration.userId");
		}
	}

	@priority = 3
	test JSONTConfigurationObjectContainsVersion {
		task ("When in Import/Export: exporting Catalog Commerce Entity type with JSONT format with all fields to include selected") {
			ImportExport.exportEntityWithAllFieldsInJsontFormat(entityType = "Catalog (v1_0 - Liferay Headless Commerce Admin Catalog)");
		}

		task ("And When I download generated file") {
			ImportExport.unzipDownloadedExportFile();
		}

		task ("Then the jsont format file contains configuration node with version parameter with value {current version of Catalog}") {
			BatchEngine.assertExportedFileContainsCorrectObject(
				expectedValue = "v1.0",
				fileName = "export.batch-engine-data.json",
				jsonObject = "$.configuration.version");
		}
	}

}