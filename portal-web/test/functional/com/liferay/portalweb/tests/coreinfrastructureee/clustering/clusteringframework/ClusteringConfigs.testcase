@component-name = "portal-clustering"
definition {

	property app.server.bundles.size = "1";
	property cluster.enabled = "true";
	property minimum.slave.ram = "24";
	property portal.release = "true";
	property portal.upstream = "quarantine";
	property remote.elasticsearch.enabled = "true";
	property test.assert.warning.exceptions = "true";
	property testray.main.component.name = "Clustering";

	setUp {
		TestCase.setUpPortalInstance();

		User.firstLoginPG();
	}

	tearDown {
		var testLiferayVirtualInstance = PropsUtil.get("test.liferay.virtual.instance");

		if (${testLiferayVirtualInstance} == "true") {
			PortalInstances.tearDownCP();
		}
		else {
			PagesAdmin.tearDownCP();

			BlogsEntry.tearDownCP();
		}
	}

	@priority = 5
	test StartupJDBCPING {
		property app.server.types = "tomcat";
		property cluster.jdbc.ping = "true";
		property database.types = "mysql";
		property portal.acceptance = "true";
		property test.liferay.virtual.instance = "false";
		property test.run.type = "single";

		Clustering.viewClusterStatusInConsole();

		Clustering.viewTextPresentOnSpecificNode(
			expectedText = "JDBC_PING",
			nodePort = 8080);

		Clustering.viewTextPresentOnSpecificNode(
			expectedText = "JDBC_PING",
			nodePort = 9080);

		User.loginPG(
			nodePort = 9080,
			password = "test",
			userEmailAddress = "test@liferay.com");

		echo("Successfully logged in to both nodes on JDBC_PING");
	}

	@priority = 3
	test StartupJDBCPINGWithZombieEntries {
		property app.server.bundles.size = "0";
		property app.server.types = "tomcat";
		property cluster.enabled = "true";
		property cluster.tcp.jdbc.ping = "true";
		property database.types = "mysql";
		property portal.acceptance = "true";
		property test.name.skip.portal.instance = "ClusteringConfigs#StartupJDBCPINGWithZombieEntries";

		Clustering.viewTextPresentOnSpecificNode(
			expectedText = "JDBC_PING",
			nodePort = 8080);

		AntCommands.runCommand("build-test.xml", "terminate-one-java-process -Dprocess.name=Bootstrap");

		SQL.assertTextInMySQLStatementResult(
			mysqlStatement = "SELECT COUNT(*) FROM lportal.JGROUPSPING",
			text = 2);

		Portlet.startServer(deleteLiferayHome = "false");

		Smoke.viewWelcomeContentPage();
	}

}